{% extends "layout.html" %}
{% block title %}Tactical Dashboard{% endblock %}
{% block content %}
<div class="container light-theme">
    <h2 class="tactical-header text-3xl font-bold mb-4">Tactical Dashboard</h2>
    <p class="text-gray-600 text-sm mb-8">Optimize performance by analyzing revenue channels, booking conversion, and room utilization trends.</p>
    
    <!-- KPI Cards -->
    <div class="kpi-container grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
        <div id="total-revenue" class="kpi-card bg-[#FFC300] text-white font-bold p-4 rounded-lg shadow-lg" style="border-radius: 8px; padding: 12px 20px;"></div>
        <div id="total-bookings" class="kpi-card bg-[#3949AB] text-white font-bold p-4 rounded-lg shadow-lg" style="border-radius: 8px; padding: 12px 20px;"></div>
        <div id="conversion-rate" class="kpi-card bg-[#009688] text-white font-bold p-4 rounded-lg shadow-lg" style="border-radius: 8px; padding: 12px 20px;"></div>
        <div id="avg-stay-duration" class="kpi-card bg-[#8E24AA] text-white font-bold p-4 rounded-lg shadow-lg" style="border-radius: 8px; padding: 12px 20px;"></div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-8 mb-8">
        <!-- Row 1 -->
        <!-- Left: Booking Conversion Rate by Channel -->
        <div class="chart-container mb-6">
            <h3>Booking Conversion Rate by Channel</h3>
            <p class="chart-caption text-gray-500 text-xs mb-2">Shows confirmed booking % per channel</p>
            <canvas id="conversionRate"></canvas>
        </div>
        <!-- Right: ADR vs Stay Duration -->
        <div class="chart-container mb-6">
            <h3>ADR vs Stay Duration</h3>
            <p class="chart-caption text-gray-500 text-xs mb-2">Shows ADR variation by stay length and hotel type</p>
            <canvas id="adrStayDuration"></canvas>
        </div>
        <!-- Row 2 -->
        <!-- Left: Channel Revenue -->
        <div class="chart-container mb-6">
            <h3>Channel Revenue</h3>
            <p class="chart-caption text-gray-500 text-xs mb-2">Displays total revenue generated by channel</p>
            <canvas id="channelRevenue"></canvas>
        </div>
        <!-- Right: Room Type Popularity -->
        <div class="chart-container mb-6">
            <h3>Room Type Popularity</h3>
            <p class="chart-caption text-gray-500 text-xs mb-2">Compares booking share by room category</p>
            <canvas id="roomPopularity"></canvas>
        </div>
    </div>
    <!-- Insight Card (full-width) -->
    <div class="w-full mt-6 p-6 rounded-lg" style="background-color: #E8F5E9; color: #333; margin-top: 24px;">
      <span class="text-lg font-semibold">ðŸ“Š OTA channels generate higher revenue despite lower conversion â€” optimize Direct channel marketing to improve profitability.</span>
    </div>
</div>

<script>
// Load and display KPIs
async function loadKPIs() {
    const res = await fetch("/api/tactical/kpis");
    const data = await res.json();
    document.getElementById("total-revenue").innerText = `Total Revenue: ${data.total_revenue}`;
    document.getElementById("total-bookings").innerText = `Total Bookings: ${data.total_bookings}`;
    document.getElementById("conversion-rate").innerText = `Conversion Rate: ${data.conversion_rate}`;
    document.getElementById("avg-stay-duration").innerText = `Avg Stay Duration: ${data.avg_stay_duration}`;
}

// Render all charts
async function renderCharts() {
    // Conversion Rate
    const conversionData = await (await fetch("/api/tactical/conversion-rate")).json();
    new Chart(document.getElementById("conversionRate"), {
        type: "bar",
        data: {
            labels: conversionData.labels,
            datasets: [{
                label: "Conversion Rate (%)",
                data: conversionData.data,
                backgroundColor: conversionData.labels.map(label => label === 'Direct' ? '#1E88E5' : (label === 'OTA' ? '#1E88E5' : '#3949AB'))
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Conversion Rate (%)'
                    }
                }
            }
        }
    });

    // ADR vs Stay Duration
    const adrStayData = await (await fetch("/api/tactical/adr-stay-duration")).json();
    new Chart(document.getElementById("adrStayDuration"), {
        type: "scatter",
        data: {
            datasets: [
                {
                    label: 'City',
                    data: adrStayData.x.map((x, i) => ({ x: x, y: adrStayData.y[i] })).filter((_, i) => adrStayData.labels[i] === 'City'),
                    backgroundColor: '#3949AB',
                    borderColor: '#3949AB',
                },
                {
                    label: 'Resort',
                    data: adrStayData.x.map((x, i) => ({ x: x, y: adrStayData.y[i] })).filter((_, i) => adrStayData.labels[i] === 'Resort'),
                    backgroundColor: '#FF6F61',
                    borderColor: '#FF6F61',
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Stay Duration (days)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'ADR ($)'
                    }
                }
            }
        }
    });

    // Room Popularity
    const roomData = await (await fetch("/api/tactical/room-popularity")).json();
    new Chart(document.getElementById("roomPopularity"), {
        type: "doughnut",
        data: {
            labels: roomData.labels,
            datasets: [{
                data: roomData.data,
                backgroundColor: roomData.labels.map(label => label === 'City' ? '#3949AB' : (label === 'Resort' ? '#2ECC71' : '#FF6F61'))
            }]
        },
        options: { responsive: true }
    });

    // Channel Revenue
    const channelData = await (await fetch("/api/tactical/channel-revenue")).json();
    new Chart(document.getElementById("channelRevenue"), {
        type: "bar",
        data: {
            labels: channelData.labels,
            datasets: [{
                label: "Revenue",
                data: channelData.data,
                backgroundColor: channelData.labels.map(label => label === 'Direct' ? '#42A5F5' : (label === 'OTA' ? '#F06292' : '#3949AB'))
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Revenue ($)'
                    }
                }
            }
        }
    });
}

// Initialize dashboard
loadKPIs();
renderCharts();
</script>

<style>
  .tactical-header { color: #43A047; }
  .tactical-highlight { background-color: #FFA7261A; }
  .tactical-btn { background-color: #43A047; color: #fff; }
  .tactical-btn:hover { background-color: #FFA726; }
</style>
{% endblock %} 